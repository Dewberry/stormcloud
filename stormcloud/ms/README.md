# Meilisearch Functions

## Summary

The scripts in this directory are to be used for triggering updates to or querying information from the meilisearch database holding statistics and s3 URIs relating to SST model runs

## Contents

### Utility Scripts

Scripts which have no effect when launched in terminal (ie they do not have code which executes when launched, but rather contain definitions of functions, classes, or variables)

#### [client_utils.py](client_utils.py)
---
Common utilities used by multiple meilisearch scripts for creating AWS clients for interacting with meilisearch as s3 resources

#### [constants.py](constants.py)
---
Constants used to consistently reference the same meilisearch database

#### [identify.py](identify.py)
---
Script to identify start and end dates associated with the top n SST model events per year, ranked by mean precipitation. This is a utility script which has no use as a main script.


### Scripts Affecting Resources

Scripts which, when launched, have the potential to create or modify data stored in some location (ie they have a name == main trigger which launches code with provided or default parameters)

#### [create_hms_grid.py](create_hms_grid.py)
---
Script used to query data from meilisearch and use the s3 URI of the DSS files yielded from that query to create an HMS grid file. This script allows for the query made to the meilisearch database to be filtered by a selection of attributes. For more information on the usage of this script or its parameters, view the help information associated with the script by launching the script in python with the command line parameter '-h' or '--help' provided

#### [meilisearch_init.py](meilisearch_init.py)
---
Script used to create the index, or 'database', in meilisearch used to track storm data. This should not be necessary to use, but is included for traceability and provenance. For more information on the usage of this script or its parameters, view the help information associated with the script by launching the script in python with the command line parameter '-h' or '--help' provided

#### [storm_query.py](storm_query.py)
---
Script used to query the meilisearch database for storms of interest using specified filters or rankings. For more information on the usage of this script or its parameters, view the help information associated with the script by launching the script in python with the command line parameter '-h' or '--help' provided

#### [upload_documents.py](upload_documents.py)
---
Script which consumes output generated by [ranked document creation plugin](../plugins/doc_rank/README.md) to format documents as expected for ingestion into the [StormViewer](https://storms.dewberryanalytics.com/) application meilisearch database (check code for expected document structure information) **IMPORTANT NOTE ON DOCUMENT UPLOAD**: After the meilisearch documents are uploaded, the [StormViewer](https://storms.dewberryanalytics.com/) site will show the statistics of the meilisearch documents but **NOT** the PNG image associated with the document unless the bucket policy is updated with a new statement explicitly allowing the s3:GetObject action on PNG files with a prefix indicating it belongs to a given watershed. For example, after uploading new documents associated with Kanawha watershed, it was necessary to add the following JSON to the bucket policy:

```JSON
{
    "Sid": "AddPerm",
    "Effect": "Allow",
    "Principal": "*",
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::tempest/watersheds/kanawha/kanawha-transpo-area-v01/72h/pngs/*"
}
```

